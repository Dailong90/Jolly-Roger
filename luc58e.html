<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enigma – Lanterna (panel always on)</title>
<style>
  :root{ --x:50vw; --y:50vh; --r:120px; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; }
  body{ font-family: Georgia, "Times New Roman", serif; background:#000; color:#ddd; overflow:hidden; }

  .scene{
    position:relative; width:100%; height:100%;
    background: url('assets/stanza.jpg') center/cover no-repeat #0b0b0b;
    user-select: none; touch-action: none;
  }
  body.blackout .scene{ background:#000 !important; }

  .secret{
    position:absolute; inset:0; display:grid; place-items:center; text-align:center; padding:24px; pointer-events:none;
  }
  .secret p{ margin:.35rem 0; max-width:min(720px,92vw); color:#e7e7e7; }

  /* Interruttore fisso, invisibile ma cliccabile (hotspot) */
  .switch{
    position:absolute;
    left:92.56%; top:31.66%;
    width:30px; height:30px;
    transform:translate(-50%,-50%);
    background:transparent; border:none; padding:0; margin:0;
    opacity:0; cursor:pointer; z-index:30;
  }
  .switch:focus-visible{ outline:2px solid #fff; outline-offset:3px; }

  /* Overlay nero con buco circolare (attivo solo in blackout) */
  .dark{
    position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .25s ease;
  }
  body.blackout .dark{
    opacity:1;
    background:
      radial-gradient(circle at var(--x) var(--y),
        rgba(0,0,0,0) 0,
        rgba(0,0,0,0) calc(var(--r) - 10px),
        rgba(0,0,0,0.35) var(--r),
        rgba(0,0,0,0.78) calc(var(--r) + 100px),
        rgba(0,0,0,0.98) 100%);
  }

  /* Torcia: visibile solo in blackout, non ruota */
  .torch{
    position:absolute; left:0; top:0; width:26px; height:auto;
    transform:translate(-50%,-50%);
    pointer-events:none; display:none;
    filter:drop-shadow(0 2px 6px rgba(0,0,0,.6));
  }
  body.blackout .torch{ display:block; }

  /* Pannello sempre visibile (non interattivo verso la scena) */
  .panel{
    position:absolute; top:12px; right:12px; z-index:50;
    background:#0f0f0f; border:1px solid #333; border-radius:12px; padding:10px 12px;
    box-shadow:0 10px 30px rgba(0,0,0,.5);
    font-size:12px; line-height:1.35;
  }
  .panel .row{ display:flex; gap:6px; align-items:center; margin:4px 0; }
  .panel .label{ min-width:72px; color:#bbb; }
  .panel .value{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#eaeaea; }
  /* Evita che i click sul pannello spostino la torcia */
  .panel, .panel *{
    pointer-events:auto;
  }
</style>
</head>
<body>
  <div class="scene" id="scene" role="application" aria-label="Lanterna enigmistica">
    <div class="secret" aria-hidden="false">
      <div>
        <p>La chiave non brilla se non la illumini bene…</p>
        <p><strong>N 40° 56.●●●  E 014° 59.●●●</strong></p>
      </div>
    </div>

    <!-- Interruttore invisibile, fisso, cliccabile -->
    <button id="roomSwitch" class="switch" aria-label="Interruttore (toggle blackout)"></button>

    <!-- Overlay scuro con “buco” circolare -->
    <div class="dark" id="dark"></div>

    <!-- Torcia -->
    <img id="torch" class="torch" src="assets/torcia.png" alt="Torcia" />

    <!-- Pannello coordinate (sempre visibile) -->
    <div class="panel" id="coordPanel">
      <div class="row"><span class="label">PX:</span><span class="value" id="pxOut"></span></div>
      <div class="row"><span class="label">PERCENT:</span><span class="value" id="pctOut"></span></div>
      <div class="row"><span class="label">JSON:</span><span class="value" id="jsonOut"></span></div>
    </div>
  </div>

<script>
(function(){
  const scene   = document.getElementById('scene');
  const switchB = document.getElementById('roomSwitch');
  const torch   = document.getElementById('torch');
  const root    = document.documentElement;

  // Pannello output
  const pxOut   = document.getElementById('pxOut');
  const pctOut  = document.getElementById('pctOut');
  const jsonOut = document.getElementById('jsonOut');
  const panel   = document.getElementById('coordPanel');

  const LS_TORCH = 'lanterna_torch_pos_px';

  let blackout = false;
  let suppressPointerOnce = false; // evita il primo pointer dopo toggle

  // Utils
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
  const sceneRect = ()=> scene.getBoundingClientRect();

  function setTorchPos(x, y){
    root.style.setProperty('--x', x + 'px');
    root.style.setProperty('--y', y + 'px');
    torch.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;
  }
  function saveTorchPos(x, y){
    localStorage.setItem(LS_TORCH, JSON.stringify({x,y}));
  }
  function loadTorchPos(){
    try{
      const raw = localStorage.getItem(LS_TORCH);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(typeof obj.x === 'number' && typeof obj.y === 'number') return obj;
      return null;
    }catch{ return null; }
  }

  // Evita che i click sul pannello muovano la torcia
  ['pointerdown','pointerup','click','pointermove'].forEach(evt=>{
    panel.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false});
  });

  // Interruttore: toggle blackout (e non far passare l'evento)
  ['pointerdown','pointerup','click'].forEach(evt=>{
    switchB.addEventListener(evt, (e)=>{
      e.preventDefault();
      e.stopPropagation();
      if(evt === 'click'){
        blackout = !blackout;
        document.body.classList.toggle('blackout', blackout);

        if(blackout){
          const saved = loadTorchPos();
          const r = sceneRect();
          const x = saved ? clamp(saved.x, 0, r.width) : r.width/2;
          const y = saved ? clamp(saved.y, 0, r.height) : r.height/2;
          setTorchPos(x, y);
          refreshPanel(x, y, r);      // aggiorna subito il pannello
          suppressPointerOnce = true;  // blocca il primissimo pointer dopo il toggle
          setTimeout(()=>{ suppressPointerOnce = false; }, 60);
        } else {
          // rimaniamo con le ultime coord salvate mostrate
          const saved = loadTorchPos();
          const r = sceneRect();
          const x = saved ? clamp(saved.x, 0, r.width) : r.width/2;
          const y = saved ? clamp(saved.y, 0, r.height) : r.height/2;
          refreshPanel(x, y, r);
        }
      }
    }, {passive:false});
  });

  // Tracking torcia (solo in blackout) – ignora pannello e interruttore
  function pointerScene(e){
    if(!blackout) return;
    if(suppressPointerOnce) return;

    const t = e.target;
    if(t.closest('.panel') || t.closest('.switch')) return;

    const r = sceneRect();
    const x = clamp(e.clientX - r.left, 0, r.width);
    const y = clamp(e.clientY - r.top , 0, r.height);
    setTorchPos(x, y);
    saveTorchPos(x, y);
    refreshPanel(x, y, r);
  }
  scene.addEventListener('pointermove', pointerScene, {passive:true});
  scene.addEventListener('pointerdown', pointerScene, {passive:true});
  scene.addEventListener('pointerenter', pointerScene, {passive:true});

  // Aggiorna pannello (usa pos attuale o salvata se non in blackout)
  function refreshPanel(x, y, r){
    const rect = r || sceneRect();
    const pxX = Math.round(x), pxY = Math.round(y);
    const leftPct = (x / rect.width)  * 100;
    const topPct  = (y / rect.height) * 100;
    pxOut.textContent  = `left(px): ${pxX}, top(px): ${pxY}`;
    pctOut.textContent = `left(%): ${leftPct.toFixed(2)}, top(%): ${topPct.toFixed(2)}`;
    jsonOut.textContent = JSON.stringify({ left: `${leftPct.toFixed(2)}%`, top: `${topPct.toFixed(2)}%` });
  }

  // Init: mostra subito le ultime coord salvate (o centro) nel pannello
  function initPanel(){
    const r = sceneRect();
    const saved = loadTorchPos();
    const x = saved ? clamp(saved.x, 0, r.width) : r.width/2;
    const y = saved ? clamp(saved.y, 0, r.height) : r.height/2;
    refreshPanel(x, y, r);
  }

  // Resize: aggiorna pannello e (se in blackout) riposiziona torcia alla salvata
  window.addEventListener('resize', ()=>{
    const r = sceneRect();
    const saved = loadTorchPos();
    const x = saved ? clamp(saved.x, 0, r.width) : r.width/2;
    const y = saved ? clamp(saved.y, 0, r.height) : r.height/2;
    if(blackout) setTorchPos(x, y);
    refreshPanel(x, y, r);
  });

  initPanel();
})();
</script>
</body>
</html>
