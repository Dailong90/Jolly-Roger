<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enigma – Lanterna (testo illuminato + tremolio)</title>
<style>
  :root{ --x:50vw; --y:50vh; --r:40px; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; }
  body{ font-family: Georgia, "Times New Roman", serif; background:#000; color:#ddd; overflow:hidden; }

  .scene{
    position:relative; width:100%; height:100%;
    background: url('assets/stanza.jpg') center/cover no-repeat #0b0b0b;
    user-select: none; touch-action: none;
  }
  body.blackout .scene{
    background: url('assets/stanza_buia.jpg') center/cover no-repeat #000;
  }

  /* Interruttore invisibile */
  .switch{
    position:absolute;
    left:92.56%; top:31.66%;
    width:30px; height:30px;
    transform:translate(-50%,-50%);
    background:transparent; border:none; padding:0; margin:0;
    opacity:0; cursor:pointer; z-index:30;
  }

  /* Overlay con maschera torcia (buio) */
  .dark{
    position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .25s ease;
    z-index:20;
  }
  body.blackout .dark{
    opacity:1;
    animation: flicker 1.6s ease-in-out infinite; /* ← anim anche qui */
    background:
      radial-gradient(circle at var(--x) var(--y),
        rgba(0,0,0,0) 0,
        rgba(0,0,0,0.1) calc(var(--r) - 20px),
        rgba(0,0,0,0.23) var(--r),
        rgba(0,0,0,0.36) calc(var(--r) + 65px),
        rgba(0,0,0,0.98) 100%);
  }

  /* Spotlight che schiarisce l'area illuminata */
  .spotlight{
    position:absolute; inset:0; pointer-events:none; opacity:0; z-index:25;
  }
  body.blackout .spotlight{
    opacity:1;
    animation: flicker 1.6s ease-in-out infinite; /* ← e anche qui */
    background:
      radial-gradient(circle at var(--x) var(--y),
        rgba(255,243,191,0.5) 0,
        rgba(251,207,85,0.25) calc(var(--r) - 20px),
        rgba(213,140,18,0.0) calc(var(--r) + 65px));
    mix-blend-mode: screen; /* schiarisce il contenuto sotto */
  }

  /* Tremolio centrato su 40px (escursione delicata) */
  @keyframes flicker{
    0%   { --r:38px; }
    25%  { --r:41px; }
    50%  { --r:39px; }
    75%  { --r:43px; }
    100% { --r:40px; }
  }

  /* Torcia */
  .torch{
    position:absolute; left:0; top:0; width:26px; height:auto;
    transform:translate(-50%,-50%);
    pointer-events:none; display:none;
    filter:drop-shadow(0 2px 6px rgba(0,0,0,.6));
    z-index:30;
  }
  body.blackout .torch{ display:block; }

  /* Testo da illuminare */
  .blackout-text{
    position:absolute; top:25px; left:125px;
    font-size:10px; color:#090909;
    z-index:10; /* sotto l’overlay scuro */
    white-space:nowrap;
  }
  body:not(.blackout) .blackout-text{ display:none; }
</style>
</head>
<body>
  <div class="scene" id="scene">
    <!-- Interruttore -->
    <button id="roomSwitch" class="switch" aria-label="Interruttore"></button>

    <!-- Testo nascosto dal buio, visibile solo nella torcia -->
    <div class="blackout-text">Sai cosa prendo?</div>

    <!-- Overlay torcia (buio) -->
    <div class="dark" id="dark"></div>

    <!-- Spotlight che schiarisce -->
    <div class="spotlight" id="spotlight"></div>

    <!-- Torcia -->
    <img id="torch" class="torch" src="assets/torcia.png" alt="Torcia" />
  </div>

<script>
(function(){
  const scene   = document.getElementById('scene');
  const switchB = document.getElementById('roomSwitch');
  const torch   = document.getElementById('torch');
  const root    = document.documentElement;

  const DEFAULT_TORCH_PCT = { left: 68.37, top: 66.85 };

  let blackout = false;
  let suppressPointerOnce = false;

  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
  const sceneRect = ()=> scene.getBoundingClientRect();

  function setTorchPos(x, y){
    root.style.setProperty('--x', x + 'px');
    root.style.setProperty('--y', y + 'px');
    torch.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;
  }

  // Toggle blackout
  switchB.addEventListener('click', (e)=>{
    e.preventDefault();
    e.stopPropagation();
    blackout = !blackout;
    document.body.classList.toggle('blackout', blackout);

    if(blackout){
      const r = sceneRect();
      const x = (DEFAULT_TORCH_PCT.left / 100) * r.width;
      const y = (DEFAULT_TORCH_PCT.top  / 100) * r.height;
      setTorchPos(x, y);
      suppressPointerOnce = true;
      setTimeout(()=>{ suppressPointerOnce = false; }, 60);
    }
  }, {passive:false});

  // Movimento torcia
  function pointerScene(e){
    if(!blackout) return;
    if(suppressPointerOnce) return;
    if(e.target.closest('.switch')) return;

    const r = sceneRect();
    const x = clamp(e.clientX - r.left, 0, r.width);
    const y = clamp(e.clientY - r.top , 0, r.height);
    setTorchPos(x, y);
  }
  scene.addEventListener('pointermove', pointerScene, {passive:true});
  scene.addEventListener('pointerdown', pointerScene, {passive:true});
  scene.addEventListener('pointerenter', pointerScene, {passive:true});

  // Resize
  window.addEventListener('resize', ()=>{
    if(blackout){
      const r = sceneRect();
      const x = (DEFAULT_TORCH_PCT.left / 100) * r.width;
      const y = (DEFAULT_TORCH_PCT.top  / 100) * r.height;
      setTorchPos(x, y);
    }
  });
})();
</script>
</body>
</html>
