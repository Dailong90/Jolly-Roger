<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Enigma – Tappa 2 (Anelli numerati)</title>
<style>
  :root{ --bg-url: url('assets/jolly_bay.jpg'); }
  html,body{margin:0;padding:0;height:100%;overflow:hidden}
  body{ font-family:'Georgia','Times New Roman',serif; background:#000; color:#e5e7eb; position:relative; min-height:100svh; }
  body::before{content:"";position:fixed;inset:0;background:var(--bg-url) center/cover no-repeat;z-index:-2}
  body::after{content:"";position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:-1}

  .wrap{ position:fixed; left:50%; top:60svh; transform:translate(-50%,-50%); width:min(560px,94vw); padding:16px;}
  .card{ background:#fdf6e3; color:#2e2e2e; border:2px solid #d6c29e; border-radius:12px; padding:16px;
         box-shadow:0 8px 24px rgba(0,0,0,.45), inset 0 0 40px rgba(139,69,19,.25); }
  .title{margin:0 0 8px; text-align:center; color:#5b4636; font-weight:bold;}
  .puzzle{ display:grid; grid-template-columns:1fr 1fr; gap:12px; place-items:center; margin:10px 0 6px; }
  .ring{ width:42vw; max-width:240px; aspect-ratio:1/1; touch-action:none; }
  .hint, .feedback{ font-size:13px; color:#6b5b4b; text-align:center; margin:6px 0 0;}
  .ok{ color:#0baa72; font-weight:700;}
  .btn-next{ display:none; margin:10px auto 0; height:44px; padding:0 16px; border-radius:8px; border:1px solid #8b6b1b;
             background:linear-gradient(180deg,#f5d76e,#d4a017); color:#3b2c20; font-weight:700;
             box-shadow:0 3px 6px rgba(0,0,0,.4), inset 0 2px 4px rgba(255,255,255,.4); }
</style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h3 class="title">Allinea gli Anelli Numerati</h3>
      <div class="puzzle" id="puzzle">

        <!-- ANELLO A -->
        <svg class="ring" viewBox="0 0 100 100" data-index="0" aria-label="Anello A">
          <defs>
            <linearGradient id="goldA" x1="0" x2="1"><stop offset="0" stop-color="#7a5a2e"/><stop offset="1" stop-color="#c9a85b"/></linearGradient>
          </defs>
          <!-- Bordo -->
          <circle cx="50" cy="50" r="48" fill="none" stroke="url(#goldA)" stroke-width="3"/>
          <circle cx="50" cy="50" r="35" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="8"/>
          <!-- TACCA in alto -->
          <polygon points="50,3 46.5,9.5 53.5,9.5" fill="#c9a85b" stroke="#7a5a2e" stroke-width="0.6"/>
          <line x1="50" y1="12" x2="50" y2="20" stroke="#c9a85b" stroke-width="0.8" />
          <!-- NUMERI ruotabili -->
          <g class="rotor">
            <g font-size="8" font-family="serif" fill="#24180b">
              <!-- 1..12 distribuiti ogni 30°; 1 parte in alto -->
              <text x="50" y="10" text-anchor="middle">1</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(30 50 50)">2</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(60 50 50)">3</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(90 50 50)">4</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(120 50 50)">5</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(150 50 50)">6</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(180 50 50)">7</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(210 50 50)">8</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(240 50 50)">9</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(270 50 50)">10</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(300 50 50)">11</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(330 50 50)">12</text>
            </g>
          </g>
          <!-- lettera centrale (non ruota) -->
          <text x="50" y="56" text-anchor="middle" font-size="18" fill="#5b4636" font-weight="bold">A</text>
        </svg>

        <!-- ANELLO B -->
        <svg class="ring" viewBox="0 0 100 100" data-index="1" aria-label="Anello B">
          <circle cx="50" cy="50" r="48" fill="none" stroke="#c9a85b" stroke-width="3"/>
          <circle cx="50" cy="50" r="35" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="8"/>
          <polygon points="50,3 46.5,9.5 53.5,9.5" fill="#c9a85b" stroke="#7a5a2e" stroke-width="0.6"/>
          <line x1="50" y1="12" x2="50" y2="20" stroke="#c9a85b" stroke-width="0.8" />
          <g class="rotor">
            <g font-size="8" font-family="serif" fill="#24180b">
              <text x="50" y="10" text-anchor="middle">1</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(30 50 50)">2</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(60 50 50)">3</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(90 50 50)">4</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(120 50 50)">5</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(150 50 50)">6</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(180 50 50)">7</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(210 50 50)">8</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(240 50 50)">9</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(270 50 50)">10</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(300 50 50)">11</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(330 50 50)">12</text>
            </g>
          </g>
          <text x="50" y="56" text-anchor="middle" font-size="18" fill="#5b4636" font-weight="bold">B</text>
        </svg>

        <!-- ANELLO C -->
        <svg class="ring" viewBox="0 0 100 100" data-index="2" aria-label="Anello C">
          <circle cx="50" cy="50" r="48" fill="none" stroke="#c9a85b" stroke-width="3"/>
          <circle cx="50" cy="50" r="35" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="8"/>
          <polygon points="50,3 46.5,9.5 53.5,9.5" fill="#c9a85b" stroke="#7a5a2e" stroke-width="0.6"/>
          <line x1="50" y1="12" x2="50" y2="20" stroke="#c9a85b" stroke-width="0.8" />
          <g class="rotor">
            <g font-size="8" font-family="serif" fill="#24180b">
              <text x="50" y="10" text-anchor="middle">1</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(30 50 50)">2</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(60 50 50)">3</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(90 50 50)">4</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(120 50 50)">5</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(150 50 50)">6</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(180 50 50)">7</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(210 50 50)">8</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(240 50 50)">9</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(270 50 50)">10</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(300 50 50)">11</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(330 50 50)">12</text>
            </g>
          </g>
          <text x="50" y="56" text-anchor="middle" font-size="18" fill="#5b4636" font-weight="bold">C</text>
        </svg>

        <!-- ANELLO D -->
        <svg class="ring" viewBox="0 0 100 100" data-index="3" aria-label="Anello D">
          <circle cx="50" cy="50" r="48" fill="none" stroke="#c9a85b" stroke-width="3"/>
          <circle cx="50" cy="50" r="35" fill="none" stroke="rgba(0,0,0,.25)" stroke-width="8"/>
          <polygon points="50,3 46.5,9.5 53.5,9.5" fill="#c9a85b" stroke="#7a5a2e" stroke-width="0.6"/>
          <line x1="50" y1="12" x2="50" y2="20" stroke="#c9a85b" stroke-width="0.8" />
          <g class="rotor">
            <g font-size="8" font-family="serif" fill="#24180b">
              <text x="50" y="10" text-anchor="middle">1</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(30 50 50)">2</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(60 50 50)">3</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(90 50 50)">4</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(120 50 50)">5</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(150 50 50)">6</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(180 50 50)">7</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(210 50 50)">8</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(240 50 50)">9</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(270 50 50)">10</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(300 50 50)">11</text>
              <text x="50" y="10" text-anchor="middle" transform="rotate(330 50 50)">12</text>
            </g>
          </g>
          <text x="50" y="56" text-anchor="middle" font-size="18" fill="#5b4636" font-weight="bold">D</text>
        </svg>

      </div>
      <p class="hint">Allinea i 4 anelli: porta il <strong>numero giusto</strong> sotto la <strong>tacca dorata</strong>.</p>
      <p class="hint">Soluzione corretta: A→1, B→2, C→3, D→4.</p>
      <p id="fb" class="feedback"></p>
      <button id="next" class="btn-next" type="button">Continua</button>
    </section>
  </main>

<script>
  // === CONFIG ===
  // 0° = numero "1" in alto. Per avere A→1, B→2, C→3, D→4:
  // Servono rotazioni rispettivamente: 0°, -30°, -60°, -90° (mod 360)
  const TARGETS = [ 0, 330, 300, 270 ];
  const TOL = 6;                 // tolleranza in gradi (aumenta per facilitare)
  const SUCCESS_URL = "step3.html";

  // === LOGICA ===
  const rings = [...document.querySelectorAll('.ring')];
  const state = rings.map(()=> ({angle: Math.floor(Math.random()*360)}));
  const fb = document.getElementById('fb');
  const nextBtn = document.getElementById('next');

  rings.forEach((svg,i)=> applyAngle(svg, state[i].angle));
  rings.forEach((svg, i) => {
    let dragging=false, startAngle=0, baseAngle=0;

    const center = () => {
      const r = svg.getBoundingClientRect();
      return { cx: r.left + r.width/2, cy: r.top + r.height/2 };
    };
    const angleFromEvent = (e) => {
      const p = ('touches' in e && e.touches.length) ? e.touches[0] : e;
      const {cx, cy} = center();
      const dx = p.clientX - cx, dy = p.clientY - cy;
      let a = Math.atan2(dy, dx) * 180/Math.PI;
      return (a + 90 + 360) % 360;   // 0° = alto (sotto la tacca)
    };

    const onDown = (e) => {
      e.preventDefault(); dragging = true;
      startAngle = angleFromEvent(e); baseAngle = state[i].angle;
      window.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp, {once:true});
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('touchend', onUp, {once:true});
    };
    const onMove = (e) => {
      if(!dragging) return; e.preventDefault();
      const a = angleFromEvent(e);
      const delta = a - startAngle;
      state[i].angle = (baseAngle + delta + 360) % 360;
      applyAngle(svg, state[i].angle); checkAll();
    };
    const onUp = () => {
      dragging = false;
      window.removeEventListener('pointermove', onMove);
      window.removeEventListener('touchmove', onMove);
      state[i].angle = Math.round(state[i].angle/5)*5 % 360; // snap facoltativo a 5°
      applyAngle(svg, state[i].angle); checkAll();
    };

    svg.addEventListener('pointerdown', onDown);
    svg.addEventListener('touchstart', onDown, {passive:false});
  });

  function applyAngle(svg, ang){
    const rotor = svg.querySelector('.rotor');
    rotor.setAttribute('transform', `rotate(${ang} 50 50)`);
  }
  function within(a,b,t){ let d=Math.abs(a-b)%360; d = d>180 ? 360-d : d; return d<=t; }
  function checkAll(){
    const ok = state.every((s,i)=> within(s.angle, TARGETS[i], TOL));
    if(ok){ fb.textContent="✅ Combinazione corretta!"; fb.className="feedback ok"; nextBtn.style.display="block"; }
    else{ fb.textContent=""; nextBtn.style.display="none"; }
  }
  nextBtn.addEventListener('click', ()=>{ if(SUCCESS_URL) window.location.assign(SUCCESS_URL); });
</script>
</body>
</html>
